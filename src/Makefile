###############################
# Makefile for NDO
#
# Last Modified: 09-06-2009
###############################


# Source code directories
SRC_INCLUDE=../include

prefix=/usr/local/nagios
exec_prefix=${prefix}
LOGDIR=${prefix}/var
CFGDIR=${prefix}/etc
BINDIR=${exec_prefix}/bin
LIBEXECDIR=${exec_prefix}/libexec
CGIDIR=${exec_prefix}/sbin
INSTALL=/usr/bin/install -c
INSTALL_OPTS=-o nagios -g nagios

CC=gcc

CFLAGS=-g -O2 -I/usr/include/mysql -DHAVE_CONFIG_H -DDEBUG_MEMORY

# We don't like ANSI because ANSI doesn't like us! phhht!
#CFLAGS=-g -Wall -ansi -pedantic -DHAVE_CONFIG_H

# Compiler flags for use with Valgrind
#CFLAGS=-O0 -g -DHAVE_CONFIG_H

MOD_CFLAGS=-fPIC
LDFLAGS=
MOD_LDFLAGS=-shared
LIBS=
SOCKETLIBS= -lnsl
DBCFLAGS=
DBLDFLAGS=
DBLIBS= -L/usr/lib/x86_64-linux-gnu -lmysqlclient -lpthread -lz -lm -lrt -ldl
MATHLIBS=-lm
OTHERLIBS=-lrabbitmq -lmongoc -lpcre

COMMON_INC=$(SRC_INCLUDE)/config.h $(SRC_INCLUDE)/common.h $(SRC_INCLUDE)/io.h $(SRC_INCLUDE)/protoapi.h $(SRC_INCLUDE)/utils.h
COMMON_SRC=io.c utils.c
COMMON_OBJS=io.o utils.o

NDO_INC=$(SRC_INCLUDE)/ndo2db.h $(SRC_INCLUDE)/db.h $(SRC_INCLUDE)/queue.h
NDO_SRC=db.c
NDO_OBJS=db.o

CP=@CP@


all: file2sock log2ndo ndo2db ndomod sockdebug

file2sock: file2sock.c $(COMMON_INC) $(COMMON_OBJS)
	$(CC) $(CFLAGS) -o $@ file2sock.c $(COMMON_OBJS) $(LDFLAGS) $(LIBS) $(MATHLIBS) $(SOCKETLIBS) $(OTHERLIBS)

log2ndo: log2ndo.c $(COMMON_INC) $(COMMON_OBJS)
	$(CC) $(CFLAGS) -o $@ log2ndo.c $(COMMON_OBJS) $(LDFLAGS) $(LIBS) $(MATHLIBS) $(SOCKETLIBS) $(OTHERLIBS)

ndo2db:
	$(MAKE) ndo2db-2x
	$(MAKE) ndo2db-3x

ndo2db-2x: queue.c ndo2db.c $(NDO_INC) $(NDO_OBJS) $(COMMON_INC) $(COMMON_OBJS) dbhandlers-2x.o
	$(CC) $(CFLAGS) $(DBCFLAGS) -D BUILD_NAGIOS_2X -o ndo2db-2x queue.c ndo2db.c dbhandlers-2x.o $(COMMON_OBJS) $(NDO_OBJS) $(LDFLAGS) $(DBLDFLAGS) $(LIBS) $(SOCKETLIBS) $(DBLIBS) $(MATHLIBS) $(OTHERLIBS)

ndo2db-3x: queue.c ndo2db.c $(NDO_INC) $(NDO_OBJS) $(COMMON_INC) $(COMMON_OBJS) dbhandlers-3x.o
	$(CC) $(CFLAGS) $(DBCFLAGS) -D BUILD_NAGIOS_3X -o ndo2db-3x queue.c ndo2db.c dbhandlers-3x.o $(COMMON_OBJS) $(NDO_OBJS) $(LDFLAGS) $(DBLDFLAGS) $(LIBS) $(SOCKETLIBS) $(DBLIBS) $(MATHLIBS) $(OTHERLIBS)

ndomod: 
	$(MAKE) ndomod-2x.o
	$(MAKE) ndomod-3x.o

ndomod-2x.o: ndomod.c $(COMMON_INC) $(COMMON_OBJS)
	$(CC) $(MOD_CFLAGS) $(CFLAGS) -D BUILD_NAGIOS_2X -o ndomod-2x.o ndomod.c $(COMMON_OBJS) $(MOD_LDFLAGS) $(LDFLAGS) $(LIBS) $(SOCKETLIBS) $(OTHERLIBS)

ndomod-3x.o: ndomod.c $(COMMON_INC) $(COMMON_OBJS)
	$(CC) $(MOD_CFLAGS) $(CFLAGS) -D BUILD_NAGIOS_3X -o ndomod-3x.o ndomod.c cJSON.c $(COMMON_OBJS) $(MOD_LDFLAGS) $(LDFLAGS) $(LIBS) $(SOCKETLIBS) $(OTHERLIBS)

sockdebug: sockdebug.c $(COMMON_INC) $(COMMON_OBJS)
	$(CC) $(CFLAGS) -o $@ sockdebug.c $(COMMON_OBJS) $(LDFLAGS) $(LIBS) $(MATHLIBS) $(SOCKETLIBS) $(OTHERLIBS)

io.o: io.c $(SRC_INCLUDE)/io.h
	$(CC) $(MOD_CFLAGS) $(CFLAGS) -c -o $@ io.c

utils.o: utils.c $(SRC_INCLUDE)/utils.h
	$(CC) $(MOD_CFLAGS) $(CFLAGS) -c -o $@ utils.c

db.o: db.c $(SRC_INCLUDE)/db.h
	$(CC) $(CFLAGS) -c -o $@ db.c

dbhandlers-2x.o: dbhandlers.c $(SRC_INCLUDE)/dbhandlers.h
	$(CC) $(CFLAGS) -D BUILD_NAGIOS_2X -c -o $@ dbhandlers.c

dbhandlers-3x.o: dbhandlers.c $(SRC_INCLUDE)/dbhandlers.h
	$(CC) $(CFLAGS) -D BUILD_NAGIOS_3X -c -o $@ dbhandlers.c

clean:
	rm -f core file2sock log2ndo ndo2db-2x ndo2db-3x sockdebug *.o
	rm -f *~ */*~

distclean: clean
	rm -f Makefile

devclean: distclean

install: install-3x
	$(INSTALL) -m 774 $(INSTALL_OPTS) file2sock $(DESTDIR)$(BINDIR)
	$(INSTALL) -m 774 $(INSTALL_OPTS) log2ndo $(DESTDIR)$(BINDIR)
	$(INSTALL) -m 774 $(INSTALL_OPTS) sockdebug $(DESTDIR)$(BINDIR)
	@echo ""
	@echo "  Hint: NDOUtils Installation against Nagios v3.x"
	@echo "  completed."
	@echo ""
	@echo "  If you want to install NDOUtils for Nagios v2.x"
	@echo "  please type  'make install-2x"
	@echo ""
	@echo ""
	@echo "  Next step should be the database initialization/upgrade"
	@echo "  cd into the db/ directory and either:"
	@echo "     ./installdb  (for a new installation) or:"
	@echo "     ./upgradedb  (for an existing one)"
	@echo ""

install-2x:
	$(INSTALL) -m 775 $(INSTALL_OPTS) -d $(DESTDIR)$(BINDIR)
	$(INSTALL) -m 755 $(INSTALL_OPTS) ndo2db-2x $(DESTDIR)$(BINDIR)/ndo2db
	$(INSTALL) -m 755 $(INSTALL_OPTS) ndomod-2x.o $(DESTDIR)$(BINDIR)/ndomod.o

install-3x:
	$(INSTALL) -m 775 $(INSTALL_OPTS) -d $(DESTDIR)$(BINDIR)
	$(INSTALL) -m 755 $(INSTALL_OPTS) ndo2db-3x $(DESTDIR)$(BINDIR)/ndo2db
	$(INSTALL) -m 755 $(INSTALL_OPTS) ndomod-3x.o $(DESTDIR)$(BINDIR)/ndomod.o

